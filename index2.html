<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware Shop Client Portal</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="app" class="flex flex-col flex-1 max-w-5xl mx-auto w-full p-4 md:p-8">
        <!-- Header -->
        <header class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Hardware & Materials</h1>
            <div class="flex items-center space-x-4">
                <nav>
                    <button onclick="changeView('catalog')" class="py-2 px-4 rounded-full transition-colors duration-200 text-sm font-medium hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Catalog
                    </button>
                    <button onclick="changeView('order-history')" class="py-2 px-4 rounded-full transition-colors duration-200 text-sm font-medium hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        My Orders
                    </button>
                </nav>
            </div>
        </header>

        <!-- User Info -->
        <div id="user-info" class="bg-white p-3 rounded-lg shadow-sm mb-6 text-sm text-gray-600">
            <span id="auth-status" class="text-gray-500 italic">Connecting to Firebase...</span>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 bg-white p-6 rounded-xl shadow-md">
            <!-- Content will be injected here by JavaScript -->
        </main>

        <!-- Modals and Popups -->
        <div id="modal-container" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h2 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800"></h2>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <button onclick="hideModal()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition-colors">
                    Close
                </button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Setup ---
        let db;
        let auth;
        let userId;

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug'); // Enable Firestore debug logs

        // Check for the initial auth state and sign in
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Authenticated as:", user.uid);
                userId = user.uid;
                document.getElementById('auth-status').innerHTML = `Logged in as: <span class="font-mono text-gray-900">${userId}</span>`;
                // Start listening to data once authenticated
                listenForOrders();
                changeView('catalog');
            } else {
                console.log("Not authenticated, signing in...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showModal('Authentication Failed', `Could not connect to Firebase: ${error.message}`);
                }
            }
        });

        // --- UI State Management ---
        let currentView = 'catalog';
        const mainContentEl = document.getElementById('main-content');
        const modalContainerEl = document.getElementById('modal-container');
        let placedOrders = [];

        window.changeView = (view) => {
            currentView = view;
            renderView();
        };

        const renderView = () => {
            mainContentEl.innerHTML = ''; // Clear previous content
            if (!userId) {
                mainContentEl.innerHTML = `<div class="text-center p-8 text-gray-500">Please wait, connecting to the database...</div>`;
                return;
            }

            if (currentView === 'catalog') {
                renderCatalog();
            } else if (currentView === 'order-form') {
                renderOrderForm();
            } else if (currentView === 'order-history') {
                renderOrderHistory();
            }
        };

        const materials = [
            { id: 'steel_rebar', name: 'Steel Rebar', image: 'https://placehold.co/400x300/e5e7eb/6b7280?text=Steel+Rebar', desc: 'High-strength steel bars for concrete reinforcement.' },
            { id: 'cement', name: 'Cement Bag', image: 'https://placehold.co/400x300/e5e7eb/6b7280?text=Cement', desc: 'Portland cement, ideal for all construction needs.' },
            { id: 'pvc_pipe', name: 'PVC Pipes', image: 'https://placehold.co/400x300/e5e7eb/6b7280?text=PVC+Pipe', desc: 'Durable and lightweight pipes for plumbing.' },
            { id: 'electrical_wire', name: 'Electrical Wiring', image: 'https://placehold.co/400x300/e5e7eb/6b7280?text=Wiring', desc: 'Copper wiring for all residential and commercial projects.' },
        ];

        const renderCatalog = () => {
            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Material Catalog</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${materials.map(material => `
                        <div class="bg-gray-50 p-4 rounded-xl shadow-md border border-gray-200">
                            <img src="${material.image}" alt="${material.name}" class="rounded-lg w-full h-48 object-cover mb-4">
                            <h3 class="text-xl font-semibold text-gray-900 mb-1">${material.name}</h3>
                            <p class="text-gray-600 text-sm mb-4">${material.desc}</p>
                            <button onclick="prepareOrder('${material.id}', '${material.name}')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-full font-medium hover:bg-blue-700 transition-colors">
                                Place Order
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        window.prepareOrder = (materialId, materialName) => {
            window.selectedMaterial = { id: materialId, name: materialName };
            changeView('order-form');
        };

        const renderOrderForm = () => {
            const materialName = window.selectedMaterial ? window.selectedMaterial.name : 'Unknown Material';
            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Place New Order</h2>
                <p class="text-gray-600 mb-6">Material: <span class="font-bold">${materialName}</span></p>
                <form id="order-form" class="space-y-6">
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="ref-image" class="block text-sm font-medium text-gray-700">Reference Image (Optional)</label>
                        <input type="file" id="ref-image" name="ref-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition-colors">
                            Place Order
                        </button>
                        <button type="button" onclick="changeView('catalog')" class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            `;
            document.getElementById('order-form').addEventListener('submit', handlePlaceOrder);
        };

        const renderOrderHistory = () => {
            if (placedOrders.length === 0) {
                mainContentEl.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">My Orders</h2>
                    <div class="text-center text-gray-500 p-8">You have not placed any orders yet.</div>
                `;
            } else {
                mainContentEl.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">My Orders</h2>
                    <div class="space-y-4">
                        ${placedOrders.map(order => `
                            <div class="bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-200">
                                <p class="text-gray-800 font-medium">${order.materialName} - <span class="text-blue-600">${order.quantity} units</span></p>
                                <p class="text-sm text-gray-500">Notes: ${order.notes || 'N/A'}</p>
                                <p class="text-xs text-gray-400 mt-2">Placed: ${new Date(order.timestamp).toLocaleString()}</p>
                                <p class="text-sm font-semibold mt-2">Status: <span class="font-bold text-green-600">${order.status}</span></p>
                                <p class="text-xs text-gray-400 mt-1">Order ID: <span class="font-mono">${order.id}</span></p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        };

        // --- Data Handling ---
        const handlePlaceOrder = async (event) => {
            event.preventDefault();
            const form = event.target;
            const quantity = form.querySelector('#quantity').value;
            const notes = form.querySelector('#notes').value;
            const refImageFile = form.querySelector('#ref-image').files[0];
            const material = window.selectedMaterial;

            let refImageBase64 = null;
            if (refImageFile) {
                // Convert image to Base64 to store in Firestore (for this simple prototype)
                const reader = new FileReader();
                reader.onloadend = async () => {
                    refImageBase64 = reader.result;
                    await saveOrderToFirestore(quantity, notes, refImageBase64, material);
                };
                reader.readAsDataURL(refImageFile);
            } else {
                await saveOrderToFirestore(quantity, notes, null, material);
            }
        };

        const saveOrderToFirestore = async (quantity, notes, refImage, material) => {
            if (!userId) {
                console.error("User not authenticated, cannot save order.");
                showModal('Error', 'Please wait for authentication to complete.');
                return;
            }
            try {
                const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
                const newOrder = {
                    materialId: material.id,
                    materialName: material.name,
                    quantity: Number(quantity),
                    notes: notes,
                    refImage: refImage, // Storing as Base64 for simplicity
                    status: 'Pending',
                    timestamp: new Date().toISOString(),
                };
                await addDoc(ordersCollectionRef, newOrder);
                showModal('Order Placed!', 'Your order has been successfully submitted. We will notify you when it is processed.');
                changeView('order-history');
            } catch (error) {
                console.error("Error adding document:", error);
                showModal('Error', `Failed to place order: ${error.message}`);
            }
        };

        // Real-time listener for orders
        const listenForOrders = () => {
            const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
            onSnapshot(ordersCollectionRef, (querySnapshot) => {
                placedOrders = [];
                querySnapshot.forEach((doc) => {
                    placedOrders.push({ id: doc.id, ...doc.data() });
                });
                console.log("Updated orders:", placedOrders);
                // Re-render the view if the user is on the order history page
                if (currentView === 'order-history') {
                    renderOrderHistory();
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                showModal('Error', `Failed to fetch orders: ${error.message}`);
            });
        };

        // --- Modal Functions ---
        const showModal = (title, message) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            modalContainerEl.classList.remove('hidden');
        };

        window.hideModal = () => {
            modalContainerEl.classList.add('hidden');
        };

        // --- Initial Render ---
        window.onload = () => {
            renderView(); // Initial render to show loading state
        };
    </script>
</body>
</html>
























